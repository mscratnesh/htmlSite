<div class="page-meta" data-page-title="Portfolio Beta Calculator | Let Money Earn" data-page-description="Calculate your portfolio beta vs Nifty 50. Understand your portfolio's volatility and risk relative to the market."></div>
<h1 class="page-title">Portfolio Beta Calculator</h1>

<style>
.beta-input-group {
    margin-bottom: 15px;
}
.beta-input-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #555;
}
.beta-input-group input, .beta-input-group select, .beta-input-group textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
}
.beta-input-group textarea {
    min-height: 150px;
    font-family: monospace;
    font-size: 12px;
}
.beta-portfolio-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 14px;
}
.beta-portfolio-table th, .beta-portfolio-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}
.beta-portfolio-table th {
    background-color: #22b573;
    color: white;
}
.beta-btn-primary {
    background-color: #22b573;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-right: 10px;
}
.beta-btn-primary:hover {
    background-color: #1a8f5a;
}
.beta-btn-secondary {
    background-color: #ff9800;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
.beta-btn-remove {
    background-color: #f44336;
    padding: 5px 10px;
    font-size: 12px;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
.beta-result-box {
    margin-top: 30px;
    padding: 20px;
    background-color: #e8f5e9;
    border-left: 4px solid #22b573;
    border-radius: 4px;
}
.beta-result-box h2 {
    margin-top: 0;
    color: #22b573;
}
.beta-result-value {
    font-size: 36px;
    font-weight: bold;
    color: #22b573;
    text-align: center;
    margin: 20px 0;
}
.beta-interpretation {
    margin-top: 15px;
    padding: 10px;
    background-color: #fff;
    border-radius: 4px;
}
.beta-info-box {
    background-color: #fff3cd;
    border: 1px solid #ffc107;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 15px;
    font-size: 14px;
}
.beta-loading { color: #ff9800; font-weight: bold; }
.beta-error { color: #f44336; }
.beta-success { color: #22b573; }
</style>

<div class="card-section">
    <h2 class="section-header" style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:1.5em;">📊</span>
        <span>Portfolio Beta Calculator (vs Nifty 50)</span>
    </h2>
    <div class="card-content">
        <div class="beta-info-box" style="background: linear-gradient(135deg, #22b573 0%, #1a8f5a 100%); color: white; border: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="flex: 1; min-width: 250px;">
                    <strong style="font-size: 1.1em;">📚 New to Portfolio Beta?</strong>
                    <p style="margin: 8px 0 0 0; opacity: 0.95;">Learn how to calculate and use portfolio beta for hedging with our comprehensive guide.</p>
                </div>
                <a href="#portfolio-beta-guide" onclick="loadPage('portfolio-beta-guide')" style="background: white; color: #22b573; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: bold; white-space: nowrap; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                    📖 Read the Guide
                </a>
            </div>
        </div>
        
        <div class="beta-info-box">
            <strong>Note:</strong> Beta values are fetched from Yahoo Finance. Currency symbols (₹) and commas will be automatically removed from pasted data.
            <br><br>
            <strong>How to use:</strong> Copy data from Google Sheets or Excel with 2 columns (Script, Invested) and paste below.
            <br><br>
            <strong>Example format:</strong><br>
            Script&nbsp;&nbsp;&nbsp;&nbsp;Invested<br>
            RELIANCE&nbsp;&nbsp;₹250,000<br>
            TCS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;₹175,000<br>
            INFY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;₹300,000
        </div>
        
        <div class="beta-input-group">
            <label for="betaPasteData">Paste Data Here</label>
            <textarea id="betaPasteData" placeholder="Paste your data from Google Sheets or Excel here..."></textarea>
        </div>
        
        <div class="beta-input-group">
            <label for="betaDelimiter">Data Separator</label>
            <select id="betaDelimiter">
                <option value="tab">Tab (from Excel/Sheets)</option>
                <option value="comma">Comma (CSV)</option>
            </select>
        </div>
        
        <div class="beta-input-group">
            <label>
                <input type="checkbox" id="betaHasHeaders" checked>
                First row contains headers
            </label>
        </div>
        
        <button class="beta-btn-primary" onclick="window.importBetaData()">Import Data</button>
        <button class="beta-btn-secondary" onclick="window.clearBetaPasteArea()">Clear</button>
        
        <table class="beta-portfolio-table" id="betaPortfolioTable" style="display:none;">
            <thead>
                <tr>
                    <th>Script</th>
                    <th>Invested (₹)</th>
                    <th>Weight (%)</th>
                    <th>Beta</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="betaPortfolioBody">
            </tbody>
            <tfoot>
                <tr>
                    <th>Total</th>
                    <th id="betaTotalInvested">₹0</th>
                    <th id="betaTotalWeight">100%</th>
                    <th colspan="3"></th>
                </tr>
            </tfoot>
        </table>
        
        <button class="beta-btn-primary" onclick="window.calculateAllBetas()" style="margin-top: 20px;">Fetch Beta Values</button>
        <button class="beta-btn-primary" onclick="window.calculatePortfolioBeta()" style="margin-top: 20px;">Calculate Portfolio Beta</button>
        <button class="beta-btn-secondary" onclick="window.clearBetaPortfolio()">Clear All</button>
        
        <div id="betaResultBox" class="beta-result-box" style="display:none;">
            <h2>Portfolio Beta Result</h2>
            <div class="beta-result-value" id="betaValueDisplay">0.00</div>
            <div class="beta-interpretation" id="betaInterpretation"></div>
            
            <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 2px solid #22b573;">
                <p style="margin-bottom: 15px; color: #555;">
                    <strong>Want to know how to hedge this portfolio?</strong>
                </p>
                <a href="#portfolio-beta-guide" onclick="loadPage('portfolio-beta-guide')" style="display: inline-block; background: linear-gradient(135deg, #22b573 0%, #1a8f5a 100%); color: white; padding: 12px 30px; text-decoration: none; border-radius: 6px; font-weight: bold; box-shadow: 0 4px 12px rgba(34, 181, 115, 0.3);">
                    🛡️ Learn Hedging Strategy
                </a>
            </div>
        </div>
    </div>
</div>

<div class="card-section" id="portfolio-beta-guide" style="display:none;">
    <h2 class="section-header" style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:1.5em;">📘</span>
        <span>Guide: Understanding and Using Portfolio Beta</span>
    </h2>
    <div class="card-content">
        <h3 style="color:#22b573;margin-top:0;">What is Portfolio Beta?</h3>
        <p style="line-height:1.7;">
            <strong>Beta</strong> measures how much your portfolio moves relative to the market (Nifty 50 in this case). 
            It's a statistical measure of volatility and correlation:
        </p>
        <ul style="line-height:1.7;margin-bottom:1.5em;">
            <li><strong>Beta = 1.0:</strong> Portfolio moves exactly with the market</li>
            <li><strong>Beta > 1.0:</strong> Portfolio is more volatile (amplifies market moves)</li>
            <li><strong>Beta < 1.0:</strong> Portfolio is less volatile (dampens market moves)</li>
            <li><strong>Beta = 0:</strong> No correlation with the market</li>
            <li><strong>Negative Beta:</strong> Moves opposite to the market</li>
        </ul>

        <h3 style="color:#22b573;">How to Hedge Your Portfolio with Nifty Puts</h3>
        <p style="line-height:1.7;">
            Once you know your portfolio beta, you can use <strong>Nifty Put Options</strong> to protect against market downturns:
        </p>

        <h4 style="color:#333;margin-top:1.5em;">Step-by-Step Hedging Process:</h4>
        <div style="background:#f5f9ff;padding:15px;border-left:4px solid #2196F3;border-radius:4px;margin:1em 0;">
            <p style="margin:0 0 0.8em 0;"><strong>Step 1: Calculate Portfolio Value</strong></p>
            <p style="margin:0 0 0.8em 0;font-family:monospace;background:#fff;padding:10px;border-radius:4px;">
                Portfolio Value = Total Invested Amount (from calculator above)
            </p>

            <p style="margin:1.5em 0 0.8em 0;"><strong>Step 2: Calculate Beta-Adjusted Exposure</strong></p>
            <p style="margin:0 0 0.8em 0;font-family:monospace;background:#fff;padding:10px;border-radius:4px;">
                Adjusted Exposure = Portfolio Value × Portfolio Beta
            </p>

            <p style="margin:1.5em 0 0.8em 0;"><strong>Step 3: Calculate Number of Nifty Lots Required</strong></p>
            <p style="margin:0 0 0.8em 0;font-family:monospace;background:#fff;padding:10px;border-radius:4px;">
                Number of Lots = Adjusted Exposure ÷ (Nifty Spot × Lot Size)<br>
                Note: Nifty Lot Size = 50 (as of 2025)
            </p>
        </div>

        <h4 style="color:#333;margin-top:1.5em;">Practical Example:</h4>
        <div style="background:#fff9e6;padding:15px;border-left:4px solid #ff9800;border-radius:4px;margin:1em 0;">
            <p style="margin:0 0 0.5em 0;"><strong>Scenario:</strong></p>
            <ul style="margin:0 0 1em 1.5em;line-height:1.7;">
                <li>Portfolio Value: ₹10,00,000</li>
                <li>Portfolio Beta: 1.25 (from calculator)</li>
                <li>Nifty Spot: 23,000</li>
                <li>Nifty Lot Size: 50</li>
            </ul>
            
            <p style="margin:1em 0 0.5em 0;"><strong>Calculation:</strong></p>
            <p style="margin:0;font-family:monospace;background:#fff;padding:10px;border-radius:4px;">
                Adjusted Exposure = ₹10,00,000 × 1.25 = ₹12,50,000<br>
                Nifty Value per Lot = 23,000 × 50 = ₹11,50,000<br>
                <strong>Lots Required = ₹12,50,000 ÷ ₹11,50,000 ≈ 1.09 lots</strong><br>
                <br>
                <strong style="color:#22b573;">Action: Buy 1 Nifty Put Option</strong>
            </p>
        </div>

        <h4 style="color:#333;margin-top:1.5em;">Key Considerations:</h4>
        <ul style="line-height:1.7;margin-bottom:1em;">
            <li><strong>Strike Selection:</strong> Choose At-The-Money (ATM) or slightly Out-of-The-Money (OTM) puts</li>
            <li><strong>Expiry:</strong> Select 1-3 months for better cost-effectiveness</li>
            <li><strong>Cost:</strong> Put option premium is the cost of insurance (typically 1-3% of portfolio value)</li>
            <li><strong>Rolling:</strong> Roll over positions before expiry to maintain hedge</li>
            <li><strong>Dynamic Hedging:</strong> Adjust hedge if portfolio composition or beta changes significantly</li>
        </ul>

        <h4 style="color:#333;margin-top:1.5em;">Benefits of Beta-Based Hedging:</h4>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin:1em 0;">
            <div style="background:#e8f5e9;padding:12px;border-radius:6px;">
                <strong style="color:#2e7d32;">✓ Precise Protection</strong><br>
                <span style="font-size:0.95em;">Matches your portfolio's actual market exposure</span>
            </div>
            <div style="background:#e8f5e9;padding:12px;border-radius:6px;">
                <strong style="color:#2e7d32;">✓ Cost Efficient</strong><br>
                <span style="font-size:0.95em;">Only pay for the protection you need</span>
            </div>
            <div style="background:#e8f5e9;padding:12px;border-radius:6px;">
                <strong style="color:#2e7d32;">✓ Portfolio Stability</strong><br>
                <span style="font-size:0.95em;">Reduces downside volatility during corrections</span>
            </div>
            <div style="background:#e8f5e9;padding:12px;border-radius:6px;">
                <strong style="color:#2e7d32;">✓ Peace of Mind</strong><br>
                <span style="font-size:0.95em;">Sleep better during volatile markets</span>
            </div>
        </div>

        <div style="background:#ffebee;padding:15px;border-left:4px solid #f44336;border-radius:4px;margin:1.5em 0;">
            <p style="margin:0;"><strong>⚠️ Important Note:</strong> This is for educational purposes. Always consult a SEBI-registered advisor before implementing hedging strategies. Past performance doesn't guarantee future results.</p>
        </div>
    </div>
</div>

<script>
// Check if beta functions are already defined to prevent redefining
if (!window.betaPortfolio) {
    window.betaPortfolio = [];
}

window.cleanCurrencyValue = function(value) {
    if (typeof value === 'number') return value;
    return parseFloat(value.toString().replace(/[₹,\s]/g, ''));
};

window.importBetaData = function() {
    const pasteData = document.getElementById('betaPasteData').value.trim();
    const delimiter = document.getElementById('betaDelimiter').value;
    const hasHeaders = document.getElementById('betaHasHeaders').checked;
    
    if (!pasteData) {
        alert('Please paste data first');
        return;
    }
    
    const lines = pasteData.split('\n').filter(line => line.trim() !== '');
    const separator = delimiter === 'tab' ? '\t' : ',';
    let startIndex = hasHeaders ? 1 : 0;
    let importedCount = 0;
    let errors = [];
    
    for (let i = startIndex; i < lines.length; i++) {
        const parts = lines[i].split(separator).map(p => p.trim());
        
        if (parts.length < 2) {
            errors.push(`Row ${i + 1}: Invalid format (expected 2 columns, got ${parts.length})`);
            continue;
        }
        
        const symbol = parts[0].toUpperCase();
        const invested = window.cleanCurrencyValue(parts[1]);
        
        if (!symbol |