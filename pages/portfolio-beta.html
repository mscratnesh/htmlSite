<div class="page-meta" data-page-title="Portfolio Beta Calculator | Let Money Earn" data-page-description="Calculate your portfolio beta vs Nifty 50. Understand your portfolio's volatility and risk relative to the market."></div>
<h1 class="page-title">Portfolio Beta Calculator</h1>

<style>
.beta-input-group {
    margin-bottom: 15px;
}
.beta-input-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #555;
}
.beta-input-group input, .beta-input-group select, .beta-input-group textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
}
.beta-input-group textarea {
    min-height: 150px;
    font-family: monospace;
    font-size: 12px;
}
.beta-portfolio-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 14px;
}
.beta-portfolio-table th, .beta-portfolio-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}
.beta-portfolio-table th {
    background-color: #22b573;
    color: white;
}
.beta-btn-primary {
    background-color: #22b573;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-right: 10px;
}
.beta-btn-primary:hover {
    background-color: #1a8f5a;
}
.beta-btn-secondary {
    background-color: #ff9800;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
.beta-btn-remove {
    background-color: #f44336;
    padding: 5px 10px;
    font-size: 12px;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
.beta-result-box {
    margin-top: 30px;
    padding: 20px;
    background-color: #e7f3fe;
    border-left: 4px solid #2196F3;
    border-radius: 4px;
}
.beta-result-box h2 {
    margin-top: 0;
    color: #2196F3;
}
.beta-result-value {
    font-size: 36px;
    font-weight: bold;
    color: #2196F3;
    text-align: center;
    margin: 20px 0;
}
.beta-interpretation {
    margin-top: 15px;
    padding: 10px;
    background-color: #fff;
    border-radius: 4px;
}
.beta-info-box {
    background-color: #fff3cd;
    border: 1px solid #ffc107;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 15px;
    font-size: 14px;
}
.beta-loading { color: #ff9800; font-weight: bold; }
.beta-error { color: #f44336; }
.beta-success { color: #22b573; }
</style>

<div class="card-section">
    <h2 class="section-header" style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:1.5em;">📊</span>
        <span>Portfolio Beta Calculator (vs Nifty 50)</span>
    </h2>
    <div class="card-content">
        <div class="beta-info-box">
            <strong>Note:</strong> Beta values are fetched from Yahoo Finance. Currency symbols (₹) and commas will be automatically removed from pasted data.
            <br><br>
            <strong>How to use:</strong> Copy data from Google Sheets or Excel with 2 columns (Script, Invested) and paste below.
            <br><br>
            <strong>Example format:</strong><br>
            Script&nbsp;&nbsp;&nbsp;&nbsp;Invested<br>
            RELIANCE&nbsp;&nbsp;₹250,000<br>
            TCS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;₹175,000<br>
            INFY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;₹300,000
        </div>
        
        <div class="beta-input-group">
            <label for="betaPasteData">Paste Data Here</label>
            <textarea id="betaPasteData" placeholder="Paste your data from Google Sheets or Excel here..."></textarea>
        </div>
        
        <div class="beta-input-group">
            <label for="betaDelimiter">Data Separator</label>
            <select id="betaDelimiter">
                <option value="tab">Tab (from Excel/Sheets)</option>
                <option value="comma">Comma (CSV)</option>
            </select>
        </div>
        
        <div class="beta-input-group">
            <label>
                <input type="checkbox" id="betaHasHeaders" checked>
                First row contains headers
            </label>
        </div>
        
        <button class="beta-btn-primary" onclick="window.importBetaData()">Import Data</button>
        <button class="beta-btn-secondary" onclick="window.clearBetaPasteArea()">Clear</button>
        
        <table class="beta-portfolio-table" id="betaPortfolioTable" style="display:none;">
            <thead>
                <tr>
                    <th>Script</th>
                    <th>Invested (₹)</th>
                    <th>Weight (%)</th>
                    <th>Beta</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="betaPortfolioBody">
            </tbody>
            <tfoot>
                <tr>
                    <th>Total</th>
                    <th id="betaTotalInvested">₹0</th>
                    <th id="betaTotalWeight">100%</th>
                    <th colspan="3"></th>
                </tr>
            </tfoot>
        </table>
        
        <button class="beta-btn-primary" onclick="window.calculateAllBetas()" style="margin-top: 20px;">Fetch Beta Values</button>
        <button class="beta-btn-primary" onclick="window.calculatePortfolioBeta()" style="margin-top: 20px;">Calculate Portfolio Beta</button>
        <button class="beta-btn-secondary" onclick="window.clearBetaPortfolio()">Clear All</button>
        
        <div id="betaResultBox" class="beta-result-box" style="display:none;">
            <h2>Portfolio Beta Result</h2>
            <div class="beta-result-value" id="betaValueDisplay">0.00</div>
            <div class="beta-interpretation" id="betaInterpretation"></div>
        </div>
    </div>
</div>

<script>
// Check if beta functions are already defined to prevent redefining
if (!window.betaPortfolio) {
    window.betaPortfolio = [];
}

window.cleanCurrencyValue = function(value) {
    if (typeof value === 'number') return value;
    return parseFloat(value.toString().replace(/[₹,\s]/g, ''));
};

window.importBetaData = function() {
    const pasteData = document.getElementById('betaPasteData').value.trim();
    const delimiter = document.getElementById('betaDelimiter').value;
    const hasHeaders = document.getElementById('betaHasHeaders').checked;
    
    if (!pasteData) {
        alert('Please paste data first');
        return;
    }
    
    const lines = pasteData.split('\n').filter(line => line.trim() !== '');
    const separator = delimiter === 'tab' ? '\t' : ',';
    let startIndex = hasHeaders ? 1 : 0;
    let importedCount = 0;
    let errors = [];
    
    for (let i = startIndex; i < lines.length; i++) {
        const parts = lines[i].split(separator).map(p => p.trim());
        
        if (parts.length < 2) {
            errors.push(`Row ${i + 1}: Invalid format (expected 2 columns, got ${parts.length})`);
            continue;
        }
        
        const symbol = parts[0].toUpperCase();
        const invested = window.cleanCurrencyValue(parts[1]);
        
        if (!symbol || isNaN(invested) || invested <= 0) {
            errors.push(`Row ${i + 1}: Invalid data (${symbol}, ${parts[1]})`);
            continue;
        }
        
        window.betaPortfolio.push({ symbol, invested, beta: null, status: 'Pending' });
        importedCount++;
    }
    
    window.updateBetaTable();
    
    let message = `Successfully imported ${importedCount} stock(s)`;
    if (errors.length > 0 && errors.length <= 5) {
        message += '\n\nErrors:\n' + errors.join('\n');
    } else if (errors.length > 5) {
        message += `\n\n${errors.length} rows had errors. Please check your data format.`;
    }
    
    alert(message);
    if (importedCount > 0) window.clearBetaPasteArea();
};

window.clearBetaPasteArea = function() {
    document.getElementById('betaPasteData').value = '';
};

window.updateBetaTable = function() {
    const tbody = document.getElementById('betaPortfolioBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    let totalInvested = window.betaPortfolio.reduce((sum, stock) => sum + stock.invested, 0);
    
    window.betaPortfolio.forEach((stock, index) => {
        const weight = totalInvested > 0 ? (stock.invested / totalInvested * 100) : 0;
        const betaDisplay = stock.beta !== null ? stock.beta.toFixed(4) : '-';
        const statusClass = stock.status === 'Fetched' ? 'beta-success' : 
                           stock.status === 'Error' ? 'beta-error' : 
                           stock.status === 'Loading' ? 'beta-loading' : '';
        
        tbody.innerHTML += `
            <tr>
                <td>${stock.symbol}</td>
                <td>₹${stock.invested.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>${weight.toFixed(2)}%</td>
                <td>${betaDisplay}</td>
                <td class="${statusClass}">${stock.status}</td>
                <td><button class="beta-btn-remove" onclick="window.removeBetaStock(${index})">Remove</button></td>
            </tr>
        `;
    });
    
    const totalInvestedEl = document.getElementById('betaTotalInvested');
    if (totalInvestedEl) {
        totalInvestedEl.textContent = `₹${totalInvested.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    }
    
    const tableEl = document.getElementById('betaPortfolioTable');
    if (tableEl) {
        tableEl.style.display = window.betaPortfolio.length > 0 ? 'table' : 'none';
    }
};

window.removeBetaStock = function(index) {
    window.betaPortfolio.splice(index, 1);
    window.updateBetaTable();
    const resultBox = document.getElementById('betaResultBox');
    if (resultBox) resultBox.style.display = 'none';
};

window.clearBetaPortfolio = function() {
    if (confirm('Are you sure you want to clear all stocks?')) {
        window.betaPortfolio = [];
        window.updateBetaTable();
        const resultBox = document.getElementById('betaResultBox');
        if (resultBox) resultBox.style.display = 'none';
    }
};

const fallbackBetas = {
    'RELIANCE': 1.25, 'TCS': 0.85, 'INFY': 0.90, 'HDFCBANK': 1.10,
    'ICICIBANK': 1.35, 'HDFC': 1.05, 'SBIN': 1.45, 'BHARTIARTL': 0.95,
    'ITC': 0.70, 'KOTAKBANK': 1.15, 'LT': 1.20, 'AXISBANK': 1.40,
    'HINDUNILVR': 0.65, 'ASIANPAINT': 0.80, 'MARUTI': 1.30,
    'BAJFINANCE': 1.50, 'HCLTECH': 0.88, 'WIPRO': 0.92,
    'TITAN': 1.10, 'ULTRACEMCO': 1.25, 'NESTLEIND': 0.60,
    'SUNPHARMA': 0.75, 'POWERGRID': 0.70, 'NTPC': 0.85,
    'TATASTEEL': 1.55, 'TATAMOTORS': 1.60, 'M&M': 1.35,
    'TECHM': 0.95, 'ADANIPORTS': 1.40, 'HINDALCO': 1.50
};

async function calculateBeta(symbol) {
    try {
        const yahooSymbol = `${symbol}.NS`;
        const proxyUrl = 'https://api.allorigins.win/raw?url=';
        const apiUrl = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${yahooSymbol}?modules=defaultKeyStatistics`;
        
        const response = await fetch(proxyUrl + encodeURIComponent(apiUrl));
        const data = await response.json();
        
        if (data.quoteSummary?.result?.[0]?.defaultKeyStatistics?.beta) {
            const beta = data.quoteSummary.result[0].defaultKeyStatistics.beta.raw;
            if (beta && !isNaN(beta)) return beta;
        }
    } catch (error) {
        console.log('Yahoo Finance API failed:', error);
    }
    
    return fallbackBetas[symbol] || 1.0;
}

window.calculateAllBetas = async function() {
    if (window.betaPortfolio.length === 0) {
        alert('Please add stocks first');
        return;
    }
    
    for (let i = 0; i < window.betaPortfolio.length; i++) {
        if (window.betaPortfolio[i].beta === null) {
            window.betaPortfolio[i].status = 'Loading';
            window.updateBetaTable();
            
            try {
                window.betaPortfolio[i].beta = await calculateBeta(window.betaPortfolio[i].symbol);
                window.betaPortfolio[i].status = 'Fetched';
            } catch (error) {
                window.betaPortfolio[i].status = 'Error';
                window.betaPortfolio[i].beta = fallbackBetas[window.betaPortfolio[i].symbol] || 1.0;
            }
            
            window.updateBetaTable();
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
    }
    
    alert('Beta values fetched successfully!');
};

window.calculatePortfolioBeta = function() {
    if (window.betaPortfolio.length === 0) {
        alert('Please add stocks first');
        return;
    }
    
    const pendingBetas = window.betaPortfolio.filter(s => s.beta === null);
    if (pendingBetas.length > 0) {
        alert('Please fetch beta values first by clicking "Fetch Beta Values"');
        return;
    }
    
    let totalInvested = window.betaPortfolio.reduce((sum, stock) => sum + stock.invested, 0);
    let portfolioBeta = 0;
    window.betaPortfolio.forEach(stock => {
        const weight = stock.invested / totalInvested;
        portfolioBeta += stock.beta * weight;
    });
    
    const valueDisplay = document.getElementById('betaValueDisplay');
    const interpretation = document.getElementById('betaInterpretation');
    const resultBox = document.getElementById('betaResultBox');
    
    if (valueDisplay) valueDisplay.textContent = portfolioBeta.toFixed(4);
    if (interpretation) interpretation.innerHTML = getBetaInterpretation(portfolioBeta);
    if (resultBox) resultBox.style.display = 'block';
};

function getBetaInterpretation(beta) {
    let interpretation = '<h3>What does this mean?</h3>';
    
    if (beta < 0) {
        interpretation += '<p><strong>Negative Beta:</strong> Your portfolio moves in the opposite direction to Nifty 50.</p>';
    } else if (beta >= 0 && beta < 0.8) {
        interpretation += '<p><strong>Low Beta (Defensive):</strong> Your portfolio is less volatile than Nifty 50.</p>';
    } else if (beta >= 0.8 && beta <= 1.2) {
        interpretation += '<p><strong>Moderate Beta:</strong> Your portfolio moves roughly in line with Nifty 50.</p>';
    } else {
        interpretation += '<p><strong>High Beta (Aggressive):</strong> Your portfolio is more volatile than Nifty 50.</p>';
    }
    
    interpretation += `<p>For every 1% move in Nifty 50, your portfolio is expected to move approximately ${(beta * 1).toFixed(2)}%.</p>`;
    return interpretation;
}

// Log to confirm functions are loaded
console.log('Portfolio Beta Calculator functions loaded');
</script>