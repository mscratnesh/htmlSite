<style>
    .portfolio-beta-container {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
    }
    .beta-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #ddd;
    }
    .beta-tab {
        padding: 10px 20px;
        cursor: pointer;
        background-color: #f0f0f0;
        border: none;
        border-radius: 4px 4px 0 0;
        font-size: 14px;
    }
    .beta-tab.active {
        background-color: #22b573;
        color: white;
    }
    .beta-tab-content {
        display: none;
    }
    .beta-tab-content.active {
        display: block;
    }
    .beta-input-group {
        margin-bottom: 15px;
    }
    .beta-input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
    }
    .beta-input-group input, .beta-input-group select, .beta-input-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    .beta-input-group textarea {
        min-height: 150px;
        font-family: monospace;
        font-size: 12px;
    }
    .beta-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        font-size: 14px;
    }
    .beta-table th, .beta-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    .beta-table th {
        background-color: #22b573;
        color: white;
    }
    .beta-button {
        background-color: #22b573;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
        margin-top: 10px;
    }
    .beta-button:hover {
        background-color: #1a8f5a;
    }
    .beta-button-secondary {
        background-color: #ff9800;
    }
    .beta-button-secondary:hover {
        background-color: #e68900;
    }
    .beta-remove-btn {
        background-color: #f44336;
        padding: 5px 10px;
        font-size: 12px;
    }
    .beta-remove-btn:hover {
        background-color: #da190b;
    }
    .beta-result {
        margin-top: 30px;
        padding: 20px;
        background-color: #e8f5e9;
        border-left: 4px solid #22b573;
        border-radius: 4px;
    }
    .beta-result h2 {
        margin-top: 0;
        color: #22b573;
    }
    .beta-result-value {
        font-size: 36px;
        font-weight: bold;
        color: #22b573;
        text-align: center;
        margin: 20px 0;
    }
    .beta-info-box {
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
        font-size: 14px;
    }
    .beta-loading { color: #ff9800; font-weight: bold; }
    .beta-error { color: #f44336; }
    .beta-success { color: #22b573; }
</style>

<div class="card-section">
    <h2 class="section-header" style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:1.5em;">📊</span>
        <span>Portfolio Beta Calculator (vs Nifty 50)</span>
    </h2>
    <div class="card-content">
        <div class="portfolio-beta-container">
            <div class="beta-info-box">
                <strong>Note:</strong> Beta values are fetched from Yahoo Finance. Currency symbols (₹) and commas will be automatically removed from pasted data.
            </div>
            
            <div class="beta-tabs">
                <button class="beta-tab active" onclick="switchBetaTab('manual')">Manual Entry</button>
                <button class="beta-tab" onclick="switchBetaTab('paste')">Copy & Paste</button>
                <button class="beta-tab" onclick="switchBetaTab('sheetdb')">Load from SheetDB</button>
            </div>
            
            <!-- Manual Entry Tab -->
            <div id="manual-tab" class="beta-tab-content active">
                <div class="beta-input-group">
                    <label for="betaStockSymbol">Stock Symbol (NSE)</label>
                    <input type="text" id="betaStockSymbol" placeholder="e.g., RELIANCE, TCS, INFY">
                </div>
                
                <div class="beta-input-group">
                    <label for="betaStockInvested">Invested (₹)</label>
                    <input type="number" id="betaStockInvested" step="0.01" placeholder="e.g., 250000">
                </div>
                
                <button class="beta-button" onclick="addBetaStock()">Add Stock</button>
            </div>
            
            <!-- Copy & Paste Tab -->
            <div id="paste-tab" class="beta-tab-content">
                <div class="beta-info-box">
                    <strong>How to use:</strong> Copy data from Google Sheets or Excel with 2 columns (Script, Invested) and paste below.
                    <br><br>
                    <strong>Example:</strong><br>
                    Script&nbsp;&nbsp;&nbsp;&nbsp;Invested<br>
                    RELIANCE&nbsp;&nbsp;₹615,101.00<br>
                    TCS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;₹546,381.16<br>
                    INFY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;₹300,000.00
                </div>
                
                <div class="beta-input-group">
                    <label for="betaPasteData">Paste Data Here</label>
                    <textarea id="betaPasteData" placeholder="Paste your data from Google Sheets or Excel here..."></textarea>
                </div>
                
                <div class="beta-input-group">
                    <label for="betaDelimiter">Data Separator</label>
                    <select id="betaDelimiter">
                        <option value="tab">Tab (from Excel/Sheets)</option>
                        <option value="comma">Comma (CSV)</option>
                    </select>
                </div>
                
                <div class="beta-input-group">
                    <label>
                        <input type="checkbox" id="betaHasHeaders" checked>
                        First row contains headers
                    </label>
                </div>
                
                <button class="beta-button" onclick="importBetaData()">Import Data</button>
                <button class="beta-button beta-button-secondary" onclick="clearBetaPasteArea()">Clear</button>
            </div>
            
            <!-- SheetDB Tab -->
            <div id="sheetdb-tab" class="beta-tab-content">
                <div class="beta-info-box">
                    <strong>How to use:</strong> Click the button below to fetch your portfolio data directly from your Google Sheet via SheetDB API.
                    <br><br>
                    <strong>Expected Sheet Format:</strong><br>
                    Columns: <code>Script</code>, <code>Invested</code><br>
                    Example: RELIANCE, 615101.00
                </div>
                
                <div class="beta-input-group">
                    <label for="sheetdbApiUrl">SheetDB API URL (Optional - uses default if empty)</label>
                    <input type="text" id="sheetdbApiUrl" placeholder="https://sheetdb.io/api/v1/your_sheet_id" value="https://sheetdb.io/api/v1/c9doyjtkjcurf">
                </div>
                
                <button class="beta-button" onclick="loadFromSheetDB()">Load from SheetDB</button>
                <button class="beta-button beta-button-secondary" onclick="clearSheetDBUrl()">Reset URL</button>
                
                <div id="sheetdbStatus" style="margin-top: 15px; font-weight: bold;"></div>
            </div>
            
            <table class="beta-table" id="betaPortfolioTable" style="display:none;">
                <thead>
                    <tr>
                        <th>Script</th>
                        <th>Invested (₹)</th>
                        <th>Weight (%)</th>
                        <th>Beta</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="betaPortfolioBody"></tbody>
                <tfoot>
                    <tr>
                        <th>Total</th>
                        <th id="betaTotalInvested">₹0</th>
                        <th id="betaTotalWeight">0%</th>
                        <th colspan="3"></th>
                    </tr>
                </tfoot>
            </table>
            
            <button class="beta-button" onclick="calculateAllBetaValues()">Fetch Beta Values</button>
            <button class="beta-button" onclick="calculatePortfolioBetaResult()">Calculate Portfolio Beta</button>
            <button class="beta-button beta-button-secondary" onclick="clearBetaPortfolio()">Clear All</button>
            
            <div id="betaResultBox" class="beta-result" style="display:none;">
                <h2>Portfolio Beta Result</h2>
                <div class="beta-result-value" id="betaValueDisplay">0.00</div>
                <div id="betaInterpretation"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Portfolio Beta Calculator
    window.betaPortfolio = window.betaPortfolio || [];
    
    const SHEETDB_API_URL = 'https://sheetdb.io/api/v1/c9doyjtkjcurf';
    
    function switchBetaTab(tabName) {
        document.querySelectorAll('.beta-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.beta-tab-content').forEach(content => content.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(tabName + '-tab').classList.add('active');
    }
    
    function cleanBetaCurrencyValue(value) {
        if (typeof value === 'number') return value;
        return parseFloat(value.toString().replace(/[₹,\s]/g, ''));
    }
    
    function addBetaStock() {
        const symbol = document.getElementById('betaStockSymbol').value.trim().toUpperCase();
        const invested = parseFloat(document.getElementById('betaStockInvested').value);
        
        if (!symbol || isNaN(invested) || invested <= 0) {
            alert('Please fill all fields correctly with invested amount > 0');
            return;
        }
        
        window.betaPortfolio.push({ symbol, invested, beta: null, status: 'Pending' });
        updateBetaTable();
        document.getElementById('betaStockSymbol').value = '';
        document.getElementById('betaStockInvested').value = '';
    }
    
    function importBetaData() {
        const pasteData = document.getElementById('betaPasteData').value.trim();
        const delimiter = document.getElementById('betaDelimiter').value;
        const hasHeaders = document.getElementById('betaHasHeaders').checked;
        
        if (!pasteData) { alert('Please paste data'); return; }
        
        const lines = pasteData.split('\n').filter(line => line.trim());
        const separator = delimiter === 'tab' ? '\t' : ',';
        let startIndex = hasHeaders ? 1 : 0;
        let importedCount = 0;
        let skipped = [];
        
        window.betaPortfolio = [];
        for (let i = startIndex; i < lines.length; i++) {
            const parts = lines[i].split(separator).map(p => p.trim());
            if (parts.length >= 2) {
                const symbol = parts[0].toUpperCase();
                const invested = cleanBetaCurrencyValue(parts[1]);
                
                if (symbol && invested > 0 && !isNaN(invested)) {
                    window.betaPortfolio.push({ symbol, invested, beta: null, status: 'Pending' });
                    importedCount++;
                } else if (symbol) {
                    skipped.push(symbol);
                }
            }
        }
        
        updateBetaTable();
        let msg = `Imported ${importedCount} stock(s)`;
        if (skipped.length > 0) msg += `\nSkipped ${skipped.length}: ${skipped.join(', ')}`;
        alert(msg);
        if (importedCount > 0) clearBetaPasteArea();
    }
    
    function clearBetaPasteArea() {
        document.getElementById('betaPasteData').value = '';
    }
    
    function clearSheetDBUrl() {
        document.getElementById('sheetdbApiUrl').value = SHEETDB_API_URL;
        document.getElementById('sheetdbStatus').textContent = '';
    }
    
    async function loadFromSheetDB() {
        const apiUrl = document.getElementById('sheetdbApiUrl').value.trim() || SHEETDB_API_URL;
        const statusDiv = document.getElementById('sheetdbStatus');
        
        statusDiv.innerHTML = '<span class="beta-loading">⏳ Loading data from SheetDB...</span>';
        
        try {
            const response = await fetch(apiUrl);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (!Array.isArray(data) || data.length === 0) {
                statusDiv.innerHTML = '<span class="beta-error">❌ No data found in the sheet</span>';
                return;
            }
            
            window.betaPortfolio = [];
            let importedCount = 0;
            let skipped = [];
            
            data.forEach(row => {
                const symbol = (row.Script || row.script || row.SCRIPT || '').toString().trim().toUpperCase();
                const investedValue = row.Invested || row.invested || row.INVESTED || 0;
                const invested = cleanBetaCurrencyValue(investedValue);
                
                if (symbol && invested > 0 && !isNaN(invested)) {
                    window.betaPortfolio.push({ 
                        symbol, 
                        invested, 
                        beta: null, 
                        status: 'Pending' 
                    });
                    importedCount++;
                } else if (symbol) {
                    skipped.push(symbol);
                }
            });
            
            updateBetaTable();
            
            let message = `✅ Successfully loaded ${importedCount} stock(s) from SheetDB`;
            if (skipped.length > 0) {
                message += `<br>⚠️ Skipped ${skipped.length} invalid entries: ${skipped.join(', ')}`;
            }
            statusDiv.innerHTML = `<span class="beta-success">${message}</span>`;
            
        } catch (error) {
            console.error('SheetDB fetch error:', error);
            statusDiv.innerHTML = `<span class="beta-error">❌ Error loading data: ${error.message}</span>`;
        }
    }
    
    function updateBetaTable() {
        const tbody = document.getElementById('betaPortfolioBody');
        tbody.innerHTML = '';
        
        let totalInvested = window.betaPortfolio.reduce((sum, s) => sum + s.invested, 0);
        
        window.betaPortfolio.forEach((stock, index) => {
            const weight = totalInvested > 0 ? (stock.invested / totalInvested * 100) : 0;
            const betaDisplay = stock.beta !== null ? stock.beta.toFixed(4) : '-';
            const statusClass = stock.status === 'Fetched' ? 'beta-success' : stock.status === 'Error' ? 'beta-error' : stock.status === 'Loading' ? 'beta-loading' : '';
            
            tbody.innerHTML += `<tr><td>${stock.symbol}</td><td>₹${stock.invested.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td><td>${weight.toFixed(2)}%</td><td>${betaDisplay}</td><td class="${statusClass}">${stock.status}</td><td><button class="beta-button beta-remove-btn" onclick="removeBetaStock(${index})">Remove</button></td></tr>`;
        });
        
        document.getElementById('betaTotalInvested').textContent = `₹${totalInvested.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
        document.getElementById('betaTotalWeight').textContent = '100%';
        document.getElementById('betaPortfolioTable').style.display = window.betaPortfolio.length > 0 ? 'table' : 'none';
    }
    
    function removeBetaStock(index) {
        window.betaPortfolio.splice(index, 1);
        updateBetaTable();
        document.getElementById('betaResultBox').style.display = 'none';
    }
    
    function clearBetaPortfolio() {
        if (confirm('Clear all stocks?')) {
            window.betaPortfolio = [];
            updateBetaTable();
            document.getElementById('betaResultBox').style.display = 'none';
        }
    }
    
    const betaFallbacks = {'RELIANCE': 1.25, 'TCS': 0.85, 'INFY': 0.90, 'HDFCBANK': 1.10, 'ICICIBANK': 1.35, 'HDFC': 1.05, 'SBIN': 1.45, 'BHARTIARTL': 0.95, 'ITC': 0.70, 'KOTAKBANK': 1.15, 'LT': 1.20, 'AXISBANK': 1.40, 'HINDUNILVR': 0.65, 'ASIANPAINT': 0.80, 'MARUTI': 1.30, 'BAJFINANCE': 1.50, 'HCLTECH': 0.88, 'WIPRO': 0.92, 'TITAN': 1.10, 'ULTRACEMCO': 1.25, 'NESTLEIND': 0.60, 'SUNPHARMA': 0.75, 'POWERGRID': 0.70, 'NTPC': 0.85, 'TATASTEEL': 1.55, 'TATAMOTORS': 1.60, 'M&M': 1.35, 'TECHM': 0.95, 'ADANIPORTS': 1.40, 'HINDALCO': 1.50, 'BEL': 1.15, 'HDFCLIFE': 0.95, 'BAJAJFINSV': 1.45, 'TMPV': 1.20, 'ETERNAL': 1.10};
    
    async function calculateBetaValue(symbol) {
        try {
            const yahooSymbol = `${symbol}.NS`;
            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            const apiUrl = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${yahooSymbol}?modules=defaultKeyStatistics`;
            const response = await fetch(proxyUrl + encodeURIComponent(apiUrl));
            const data = await response.json();
            if (data.quoteSummary?.result?.[0]?.defaultKeyStatistics?.beta) {
                const beta = data.quoteSummary.result[0].defaultKeyStatistics.beta.raw;
                if (beta && !isNaN(beta)) return beta;
            }
        } catch (error) { console.log('API failed:', error); }
        return betaFallbacks[symbol] || 1.0;
    }
    
    async function calculateAllBetaValues() {
        if (window.betaPortfolio.length === 0) { alert('Add stocks first'); return; }
        
        for (let i = 0; i < window.betaPortfolio.length; i++) {
            if (window.betaPortfolio[i].beta === null) {
                window.betaPortfolio[i].status = 'Loading';
                updateBetaTable();
                window.betaPortfolio[i].beta = await calculateBetaValue(window.betaPortfolio[i].symbol);
                window.betaPortfolio[i].status = 'Fetched';
                updateBetaTable();
                await new Promise(r => setTimeout(r, 1000));
            }
        }
        alert('Beta values fetched!');
    }
    
    function calculatePortfolioBetaResult() {
        if (window.betaPortfolio.length === 0) { alert('Add stocks first'); return; }
        if (window.betaPortfolio.some(s => s.beta === null)) { alert('Fetch beta values first'); return; }
        
        let totalInvested = window.betaPortfolio.reduce((sum, s) => sum + s.invested, 0);
        let pbeta = 0;
        window.betaPortfolio.forEach(s => { pbeta += s.beta * (s.invested / totalInvested); });
        
        document.getElementById('betaValueDisplay').textContent = pbeta.toFixed(4);
        document.getElementById('betaInterpretation').innerHTML = `<h3>What does this mean?</h3><p>${pbeta < 0.8 ? '📉 Low Beta (Defensive): Your portfolio is less volatile than the market' : pbeta <= 1.2 ? '📊 Moderate Beta: Your portfolio moves with the market' : '📈 High Beta (Aggressive): Your portfolio is more volatile'}</p><p><strong>For every 1% move in Nifty 50, your portfolio moves ~${(pbeta).toFixed(2)}%</strong></p>`;
        document.getElementById('betaResultBox').style.display = 'block';
    }
</script>